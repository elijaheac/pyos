#!/usr/bin/env python2

import os

def _main(cmd, *packages):
	if cmd == "update":
                set_path("/etc/pkg-index.raw", "")
		for line in get_path("/etc/pkg-sources").split("\n"):
			pid = spawn("wget", args = [line, "/etc/pkg-index.raw", "a"])
			yield SYSCALL, WAIT, pid
			
		set_path("/etc/pkg-index", {})
		for line in get_path("/etc/pkg-index.raw").split("\n"):
                        if ":" in line:
                                data = line.split(":")
                                name = data[0]
                                url = data[1]
                                set_path(os.path.join("/etc/pkg-index/", name),\
                                         url)
                del_path("/etc/pkg-index.raw")
        elif cmd == "install":
                for package in packages:
                        pkg = get_path("/etc/pkg-index/"+ package).split(';')
                        url = pkg[0]
                        ver = pkg[1]
                        pid = spawn("wget", args = [url, "/bin/" + package,\
                                              "w", True])
                        set_path("/etc/pkg-installed/" + package, ver)
                        yield SYSCALL, WAIT, pid
        elif cmd == "upgrade":
                installed = get_path("/etc/pkg-installed")
                for package, data in get_path("/etc/pkg-index").items():
                        data = data.split(";")
                        url = data[0]
                        ver = data[1]
                        if package in installed.keys():
                                if int(ver) > int(installed[package]):
                                        pid = spawn("wget", args = [url, "/bin/" + package,\
                                                      "w", True])
                                        set_path("/etc/pkg-installed/" + package, ver)
                                        yield SYSCALL, WAIT, pid
        elif cmd == "remove":
                for package in packages:
                        if package in get_path("/etc/pkg-installed").keys():
                                del_path("/etc/pkg-installed/" + package)
                                del_path("/bin/" + package)
        yield
